{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-white">Músicas Recentes</h2>
        <p class="text-white-50">Clique nas estrelas para avaliar uma música de 1 a 5.</p>
    </div>
</div>
<div class="row">
    {% for track in tracks %}
    <div class="col-md-4 mb-4">
        <div class="card bg-dark text-white">
            <img src="{{ track.album_art }}" class="card-img-top" alt="{{ track.name }}">
            <div class="card-body">
                <h5 class="card-title">{{ track.name }}</h5>
                <p class="card-text text-white-50">{{ track.artist }}</p>
                <div class="rating" data-track-id="{{ track.id }}">
                    {% for i in range(1, 6) %}
                        <span class="rating-btn {% if track.rated and track.rated >= i %}active{% endif %}" data-rating="{{ i }}">&#9733;</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
    $('.rating-btn').on('click', function() {
        let trackId = $(this).parent().data('track-id');
        let rating = $(this).data('rating');
        let card = $(this).closest('.card');
        let trackName = card.find('.card-title').text();
        let artistName = card.find('.card-text').text();

        $.ajax({
            url: "{{ url_for('main.rate') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                track_id: trackId,
                rating: rating,
                track_name: trackName,
                artist_name: artistName
            }),
            success: function(response) {
                if (response.success) {
                    
                    let ratingButtons = card.find('.rating-btn');
                    ratingButtons.each(function(index) {
                        if ($(this).data('rating') <= response.rating) {
                            $(this).addClass('active');
                        } else {
                            $(this).removeClass('active');
                        }
                    });
                }
            }
        });
    });
</script>
{% endblock %}